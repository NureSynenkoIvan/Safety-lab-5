

<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Купити ЗАЗ 968</title>
    <style>
        body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; padding: 50px; }
        .car-card { border: 1px solid #ccc; padding: 20px; border-radius: 10px; text-align: center; max-width: 400px; }
        .stock-info { font-size: 20px; color: #d9534f; font-weight: bold; margin: 15px 0; }
        #paypal-button-container { margin-top: 20px; }
        .hidden { display: none; }
    </style>
</head>
<body>
        
    <div class="car-card">
        <h1>Authentication Page</h1>
        <h1>ЗАЗ 968М "Вухатий"</h1>
        <p>Ретро класика. Пробіг 100 тис. км. Стан: на ходу.</p>
        <h2>Ціна: $100.00</h2>
        
        <div class="stock-info">
            Залишилось на складі: <span id="stock-count">Завантаження...</span> шт.
        </div>

        <div id="paypal-button-container"></div>
        
        <div id="result-message" style="margin-top: 20px; font-weight: bold;"></div>
    </div>

    <script src="https://www.paypal.com/sdk/js?client-id=Ac5VbUGI5eaX0Jm_c2PBUOBGOb-X2W-G8D5IHBcSLmBGpYgbLbQNtT58jNzhpzjv_Lof1ZNJh9ITxXB1&currency=USD"></script>

    <script>
        // 1. Оновлюємо кількість товару при завантаженні
        async function updateStock() {
            const response = await fetch('/api/stock');
            const data = await response.json();
            document.getElementById('stock-count').innerText = data.count;
            
            // Якщо машин 0, ховаємо кнопку
            if (data.count <= 0) {
                document.getElementById('paypal-button-container').innerHTML = '<h3>Розпродано!</h3>';
            }
        }
        updateStock();

        // 2. Налаштування PayPal кнопок
        paypal.Buttons({
            // Ця функція викликається, коли користувач натискає кнопку PayPal
            createOrder: function(data, actions) {
                return fetch('/api/create-order', {
                    method: 'post'
                }).then(function(res) {
                    return res.json();
                }).then(function(orderData) {
                    return orderData.id; // Повертаємо ID замовлення PayPal
                });
            },

            // Ця функція викликається, коли користувач підтвердив оплату у вікні PayPal
            onApprove: function(data, actions) {
                return fetch('/api/capture-order', {
                    method: 'post',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ orderID: data.orderID })
                }).then(function(res) {
                    return res.json();
                }).then(function(details) {
                    // Оплата пройшла!
                    if (details.status === 'success') {
                        document.getElementById('result-message').innerText = 'Успішна покупка! Дякуємо.';
                        document.getElementById('result-message').style.color = 'green';
                        updateStock(); // Оновлюємо лічильник (має стати на 1 менше)
                    } else {
                        alert('Щось пішло не так!');
                    }
                });
            },

            onError: function(err) {
                console.log(err);
                alert("Помилка оплати!");
            }
        }).render('#paypal-button-container');
    </script>
</body>
</html>